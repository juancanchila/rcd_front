<form [formGroup]="form" (ngSubmit)="onSubmit()" class="form-host">
  <mat-progress-bar mode="determinate" [value]="(step + 1) * (100 / totalSteps)">
  </mat-progress-bar>

  <!-- PASO 0: DATOS DE CONTACTO -->
  <div *ngIf="step === 0" [formGroup]="contacto">
    <h3>Datos de Contacto</h3>
    <p>Ingresar la información del propietario del vehículo.</p>

    <mat-form-field appearance="outline">
      <mat-label>Tipo de solicitante</mat-label>
      <mat-select formControlName="tipo_de_solicitante" required>
        <mat-option value="Persona Natural">Persona Natural</mat-option>
        <mat-option value="Persona Jurídica">Persona Jurídica</mat-option>
      </mat-select>
      <mat-error *ngIf="isInvalid('tipo_de_solicitante', contacto)">
        Debes seleccionar el tipo de solicitante.
      </mat-error>
    </mat-form-field>

    <!-- PERSONA NATURAL -->
    <ng-container *ngIf="contacto.get('tipo_de_solicitante')?.value === 'Persona Natural'">
      <mat-form-field appearance="outline">
        <mat-label>Nombres y apellidos</mat-label>
        <input matInput formControlName="nombres_y_apellidos" placeholder="Ej: Juan Pérez" />
        <mat-error *ngIf="isInvalid('nombres_y_apellidos', contacto)">
          Debes ingresar nombres y apellidos.
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Documento de identidad</mat-label>
        <input matInput formControlName="documento_de_identidad" placeholder="Ej: 1234567890" />
        <mat-error *ngIf="isInvalid('documento_de_identidad', contacto)">
          Debes ingresar el documento de identidad.
        </mat-error>
      </mat-form-field>
    </ng-container>

    <!-- PERSONA JURÍDICA -->
    <ng-container *ngIf="contacto.get('tipo_de_solicitante')?.value === 'Persona Jurídica'">
      <mat-form-field appearance="outline">
        <mat-label>Razón social</mat-label>
        <input
          matInput
          formControlName="razon_social"
          placeholder="Ej: Comercializadora ABC S.A.S"
        />
        <mat-error *ngIf="isInvalid('razon_social', contacto)">
          Debes ingresar la razón social.
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>NIT</mat-label>
        <input matInput formControlName="nit" placeholder="Ej: 900123456-7" />
        <mat-error *ngIf="isInvalid('nit', contacto)">Debes ingresar el NIT.</mat-error>
      </mat-form-field>
    </ng-container>

    <mat-form-field appearance="outline">
      <mat-label>Correo electrónico</mat-label>
      <input
        matInput
        type="email"
        formControlName="correo_electronico"
        placeholder="ejemplo@correo.com"
      />
      <mat-error *ngIf="isInvalid('correo_electronico', contacto)">
        Ingresa un correo válido.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Teléfono móvil</mat-label>
      <input matInput formControlName="telefono_movil" placeholder="Ej: 3001234567" />
      <mat-error *ngIf="isInvalid('telefono_movil', contacto)">
        Debes ingresar el teléfono móvil.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Teléfono fijo</mat-label>
      <input matInput formControlName="telefono_fijo" placeholder="Ej: 6051234567" />
    </mat-form-field>

<!-- SELECTOR DE CIUDAD -->
<mat-form-field appearance="outline">
  <mat-label>Ciudad</mat-label>
  <mat-select formControlName="ciudad" (selectionChange)="onCiudadChange($event.value)">
    <mat-option value="Cartagena">Cartagena</mat-option>
    <mat-option value="Otra">Otra ciudad</mat-option>
  </mat-select>
  <mat-error *ngIf="isInvalid('ciudad', contacto)">
    Debes seleccionar la ciudad.
  </mat-error>
</mat-form-field>

<!-- INPUT PARA ESCRIBIR LA CIUDAD SOLO SI ELIGE "OTRA" -->
<div *ngIf="mostrarInputOtraCiudad">
  <mat-form-field appearance="outline">
    <mat-label>Escribe la ciudad</mat-label>
    <input
      matInput
      formControlName="otraCiudad"
      (input)="onOtraCiudadInput($event.target.value)"
      required
    />
    <mat-error *ngIf="isInvalid('otraCiudad', contacto)">
      Debes ingresar la ciudad.
    </mat-error>
  </mat-form-field>
</div>

<!-- TUS CAMPOS SIN CAMBIAR -->
<div *ngIf="mostrarLocalidad">

    <mat-form-field appearance="outline">
      <mat-label>Localidad</mat-label>
      <mat-select formControlName="localidad" required>
        <mat-option value="localidad1">Localidad 1</mat-option>
        <mat-option value="localidad2">Localidad 2</mat-option>
        <mat-option value="localidad3">Localidad 3</mat-option>
      </mat-select>
      <mat-error *ngIf="isInvalid('localidad', contacto)">
        Debes seleccionar la localidad.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Barrio</mat-label>
      <input
        matInput
        formControlName="barrio"
        [matAutocomplete]="autoBarrio"
        placeholder="Empieza a escribir"
      />
      <mat-autocomplete #autoBarrio="matAutocomplete">
        <mat-option *ngFor="let barrio of barriosFiltrados$ | async" [value]="barrio">
          {{ barrio }}
        </mat-option>
      </mat-autocomplete>
      <mat-error *ngIf="isInvalid('barrio', contacto)">
        Debes seleccionar un barrio.
      </mat-error>
    </mat-form-field>

</div>



    <mat-form-field appearance="outline">
      <mat-label>Dirección de correspondencia</mat-label>
      <input
        matInput
        formControlName="direccion_de_correspondencia_del_solicitante"
        placeholder="Ej: Calle 45 #12-34"
      />
      <mat-error *ngIf="isInvalid('direccion_de_correspondencia_del_solicitante', contacto)">
        Debes ingresar la dirección de correspondencia.
      </mat-error>
    </mat-form-field>
  </div>

  <!-- PASO 1: DATOS DEL GESTOR -->
  <div *ngIf="step === 1" [formGroup]="gestor" class="gestor-step">
    <h3>Datos del Gestor</h3>

    <mat-form-field appearance="outline">
      <mat-label>Localidad del Gestor</mat-label>
      <mat-select formControlName="localidad_gestor" required>
        <mat-option value="localidad1">Localidad 1</mat-option>
        <mat-option value="localidad2">Localidad 2</mat-option>
        <mat-option value="localidad3">Localidad 3</mat-option>
      </mat-select>
      <mat-error *ngIf="isInvalid('localidad_gestor', gestor)">
        Debes seleccionar la localidad del gestor.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Barrio del Gestor</mat-label>
      <input
        matInput
        formControlName="barrio_gestor"
        [matAutocomplete]="autoBarrioGestor"
        placeholder="Empieza a escribir"
      />
      <mat-autocomplete #autoBarrioGestor="matAutocomplete">
        <mat-option *ngFor="let barrio of barriosFiltradosGestor$ | async" [value]="barrio">
          {{ barrio }}
        </mat-option>
      </mat-autocomplete>
      <mat-error *ngIf="isInvalid('barrio_gestor', gestor)">
        Debes seleccionar un barrio.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Dirección del Gestor</mat-label>
      <input matInput formControlName="direccion_gestor" placeholder="Ej: Calle 45 #12-34" />
      <mat-error *ngIf="isInvalid('direccion_gestor', gestor)">
        Debes ingresar la dirección del gestor.
      </mat-error>
    </mat-form-field>

    <map-picker (coordinates)="onMap($event)"></map-picker>

    <div class="error" *ngIf="gestor.get('latitud')?.invalid || gestor.get('longitud')?.invalid">
      Debes seleccionar una ubicación en el mapa.
    </div>

    <div class="flexbox">
      <div class="form-field">
        <label>Fecha Inicio</label>
        <input type="date" formControlName="fecha_inicio" [min]="minDate" max="2026-12-31" />
      </div>

      <div class="form-field">
        <label>Fecha Final <span class="required">*</span></label>
        <input type="date" formControlName="fecha_final" [min]="minDate" max="2026-12-31" />
        <div class="error" *ngIf="isInvalid('fecha_final', gestor)">Seleccionar fecha</div>
      </div>
    </div>

    <div class="error" *ngIf="gestor.errors?.['fechaInvalida']">
      La fecha inicial no puede ser mayor que la fecha final.
    </div>

    <div class="form-field">
      <label>Tipos de RCD</label>
      <select formControlName="tipo_rcd">
        <option value="">Seleccionar</option>
        <option value="aprovechable">RCD susceptibles de aprovechamiento</option>
        <option value="no_aprovechable">RCD no susceptibles de aprovechamiento</option>
      </select>
    </div>

    <!-- RCD SEGÚN TIPO SELECCIONADO -->
    <div class="form-field" *ngIf="gestor.get('tipo_rcd')?.value === 'aprovechable'">
      <label>Tipos de RCD (marque las que apliquen)</label>
      <div *ngFor="let key of rcdAprovechableKeys">
        <label>
          <input type="checkbox" [formControlName]="key" />
          {{ rcdAprovechable[key] }}
        </label>
      </div>
    </div>

    <div class="form-field" *ngIf="gestor.get('tipo_rcd')?.value === 'no_aprovechable'">
      <label>Tipos de RCD (marque las que apliquen)</label>
      <div *ngFor="let key of rcdNoAprovechableKeys">
        <label>
          <input type="checkbox" [formControlName]="key" />
          {{ rcdNoAprovechable[key] }}
        </label>
      </div>
    </div>

    <div class="form-field">
      <label>Actividad ejecutada <span class="required">*</span></label>
      <select formControlName="actividad_ejecutada">
        <option value="">Seleccionar</option>
        <option value="almacenamiento_punto_limpio">Almacenamiento en Punto Limpio</option>
        <option value="aprovechamiento_planta">
          Aprovechamiento a través de planta fija o móvil
        </option>
        <option value="receptor_rcd_estructural">
          Receptor de RCD para actividades estructurales
        </option>
        <option value="receptor_rcd_materia_prima">Receptor de RCD como materia prima</option>
        <option value="disposicion_final">Disposición Final</option>
      </select>
      <div class="error" *ngIf="isInvalid('actividad_ejecutada', gestor)">Campo obligatorio</div>
    </div>

    <div class="flexbox">
      <div class="form-field">
        <label>Capacidad (t/mes) <span class="required">*</span></label>
        <input type="number" formControlName="capacidad_t_mes" min="1" step="0.01" />
        <div class="error" *ngIf="isInvalid('capacidad_t_mes', gestor)">
          Campo obligatorio y debe ser mayor que 0
        </div>
      </div>

      <div class="form-field">
        <label>Capacidad total (t) <span class="required">*</span></label>
        <input type="number" formControlName="capacidad_total_t" min="1" step="0.01" />
        <div class="error" *ngIf="isInvalid('capacidad_total_t', gestor)">
          Campo obligatorio y debe ser mayor que 0
        </div>
      </div>
    </div>
  </div>

  <!-- PASO 2: DOCUMENTOS -->
  <div *ngIf="step === 2" class="documentos">
    <h3>Documentos requeridos</h3>

    <!-- PERSONA NATURAL -->
    <div *ngIf="contacto.value.tipo_de_solicitante === 'Persona Natural'" class="file-group">
      <label>Identificación (PDF) *</label>
      <input type="file" (change)="onFileSelected($event, 'identificacion')" accept=".pdf" />
    </div>

    <!-- PERSONA JURÍDICA -->
    <div *ngIf="contacto.value.tipo_de_solicitante === 'Persona Jurídica'" class="file-group">
      <label>Certificado de existencia y representación legal (PDF) *</label>
      <input type="file" (change)="onFileSelected($event, 'cert_ext_rep_legal')" accept=".pdf" />
    </div>

    <!-- DOCUMENTOS COMUNES -->
    <div class="file-group">
      <label>Documento medidas de manejo ambiental (PDF) *</label>
      <input
        type="file"
        (change)="onFileSelected($event, 'medidas_manejo_ambiental')"
        accept=".pdf"
      />
    </div>

    <div class="file-group">
      <label>Carta de Solicitud (PDF) *</label>
      <input type="file" (change)="onFileSelected($event, 'carta_solicitud')" accept=".pdf" />
    </div>

      <div class="file-group">
      <label>Soporte de pago del PIN (PDF) *</label>
      <input type="file" (change)="onFileSelected($event, 'carta_solicitud')" accept=".pdf" />
    </div>

    <div class="file-group">
      <label>Lic Urbanistica RCD</label>
      <input type="file" (change)="onFileSelected($event, 'licencia_urbanistica_rcd')" accept=".pdf" />
    </div>
    <div class="file-group">
      <label>Documento viabilidad ambiental para adecuación del terreno (PDF) *</label>
      <input
        type="file"
        (change)="onFileSelected($event, 'viabilidad_ambiental_adecuacion')"
        accept=".pdf"
      />
      <small class="file-description">
        Incluir:<br />
        • Cédula del representante legal <br />
        • Certificado de Tradición del inmueble
      </small>
    </div>

    <div class="file-group">
      <label>Permisos, licencias y autorizaciones ambientales (PDF) *</label>
      <input
        type="file"
        (change)="onFileSelected($event, 'permisos_licencias_autorizaciones')"
        accept=".pdf"
      />
    </div>

    <div class="file-group">
      <label>Certificación POT (PDF) *</label>
      <input type="file" (change)="onFileSelected($event, 'certificacion_pot')" accept=".pdf" />
    </div>

    <!-- DOCUMENTOS SEGÚN ACTIVIDAD -->
    <ng-container [ngSwitch]="gestor.value.actividad_ejecutada">
      <!-- materia prima -->
      <ng-container *ngSwitchCase="'receptor_rcd_materia_prima'">
        <div class="file-group">
          <label>Planos DWG / PDF</label>
          <input
            type="file"
            (change)="onFileSelected($event, 'planos_rcd_materiaprima')"
            accept=".pdf,.dwg"
          />
        </div>

        <div class="file-group">
          <label>Documento técnico RCD como materia prima (PDF)</label>
          <input
            type="file"
            (change)="onFileSelected($event, 'documento_tecnico_rcd_materiaprima')"
            accept=".pdf"
          />
        </div>

        <div class="file-group">
          <label>Permisos ambientales RCD materia prima (PDF)</label>
          <input
            type="file"
            (change)="onFileSelected($event, 'permisos_rcd_materiaprima')"
            accept=".pdf"
          />
        </div>
      </ng-container>

      <!-- estructural -->
      <ng-container *ngSwitchCase="'receptor_rcd_estructural'">
        <div class="file-group">
          <label>Documento técnico RCD estructural (PDF)</label>
          <input
            type="file"
            (change)="onFileSelected($event, 'documento_tecnico_rcd_estructural')"
            accept=".pdf"
          />
        </div>

        <div class="file-group">
          <label>Planos topográficos DWG / PDF</label>
          <input
            type="file"
            (change)="onFileSelected($event, 'planos_topograficos_rcd')"
            accept=".pdf,.dwg"
          />
        </div>

        <div class="file-group">
          <label>Viabilidad ambiental para adecuación del terreno (PDF)</label>
          <input
            type="file"
            (change)="onFileSelected($event, 'viabilidad_ambiental_rcd')"
            accept=".pdf"
          />
        </div>
      </ng-container>

      <!-- disposición final -->
      <ng-container *ngSwitchCase="'disposicion_final'">
        <div class="file-group">
          <label>Medidas manejo ambiental (PDF)</label>
          <input
            type="file"
            (change)="onFileSelected($event, 'medidas_manejo_disp_final')"
            accept=".pdf"
          />
        </div>

        <div class="file-group">
          <label>Permisos ambientales (PDF)</label>
          <input
            type="file"
            (change)="onFileSelected($event, 'permisos_disp_final')"
            accept=".pdf"
          />
        </div>

        <div class="file-group">
          <label>Certificación POT disposición final (PDF)</label>
          <input
            type="file"
            (change)="onFileSelected($event, 'certificacion_pot_disp_final')"
            accept=".pdf"
          />
        </div>
      </ng-container>
    </ng-container>
  </div>
  <!-- PASO 3: INFO EXTRA -->
  <div *ngIf="step === 3" [formGroup]="infoextra" class="infoextra-step">
    <h3>Información adicional</h3>

    <mat-form-field appearance="outline">
      <mat-label>Fecha de expedición del PIN</mat-label>
      <input matInput type="date" formControlName="fecha_expedicion_pin" />
      <mat-error *ngIf="isInvalid('fecha_expedicion_pin', infoextra)">
        Debes ingresar la fecha de expedición del PIN.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Consecutivo SIGOB</mat-label>
      <input matInput formControlName="consecutivo_sigob" placeholder="Ej: 2025-000123" />
      <mat-error *ngIf="isInvalid('consecutivo_sigob', infoextra)">
        Debes ingresar el consecutivo SIGOB.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Numero de Resolución</mat-label>
      <input matInput formControlName="numeroResolucion" placeholder="Ej: 2025-000123" />
      <mat-error *ngIf="isInvalid('numeroResolucion', infoextra)">
        Debes ingresar el Numero de Resolución
      </mat-error>
    </mat-form-field>

    <!-- NUEVO CAMPO: Clave -->
    <mat-form-field appearance="outline">
      <mat-label>Clave</mat-label>
      <input matInput type="text" formControlName="clave" placeholder="Ingresa tu clave" />
      <mat-error *ngIf="isInvalid('clave', infoextra)"> Debes ingresar la clave. </mat-error>
    </mat-form-field>

    <!-- NUEVO CAMPO: Cantidad Autorizada -->
    <mat-form-field appearance="outline">
      <mat-label>Cantidad autorizada (toneladas)</mat-label>
      <input
        matInput
        type="number"
        formControlName="cantidad_autorizada"
        placeholder="Ej: 5"
        min="0"
      />
      <mat-error *ngIf="isInvalid('cantidad_autorizada', infoextra)">
        Debes ingresar la cantidad autorizada.
      </mat-error>
    </mat-form-field>
  </div>

  <!-- PASO 4: RESUMEN -->
  <div *ngIf="step === 4" class="summary">
    <h3>Resumen final del trámite</h3>
    <p>Revisa que toda la información sea correcta antes de enviar.</p>

    <div class="summary-block">
      <h4>Datos de Contacto</h4>
      <p><strong>Tipo solicitante:</strong> {{ contacto.value.tipo_de_solicitante }}</p>

      <ng-container *ngIf="contacto.value.tipo_de_solicitante === 'Persona Natural'">
        <p><strong>Nombres:</strong> {{ contacto.value.nombres_y_apellidos }}</p>
        <p><strong>Documento:</strong> {{ contacto.value.documento_de_identidad }}</p>
      </ng-container>

      <ng-container *ngIf="contacto.value.tipo_de_solicitante === 'Persona Jurídica'">
        <p><strong>Razón social:</strong> {{ contacto.value.razon_social }}</p>
        <p><strong>NIT:</strong> {{ contacto.value.nit }}</p>
      </ng-container>

      <p><strong>Correo:</strong> {{ contacto.value.correo_electronico }}</p>
      <p><strong>Teléfono móvil:</strong> {{ contacto.value.telefono_movil }}</p>
      <p><strong>Localidad:</strong> {{ contacto.value.localidad }}</p>
      <p><strong>Barrio:</strong> {{ contacto.value.barrio }}</p>
      <p>
        <strong>Dirección:</strong>
        {{ contacto.value.direccion_de_correspondencia_del_solicitante }}
      </p>
      <p><strong>Latitud:</strong> {{ gestor.get('latitud')?.value }}</p>
      <p><strong>Longitud:</strong> {{ gestor.get('longitud')?.value }}</p>
    </div>

    <div class="summary-block">
      <h4>Datos del Gestor</h4>
      <p><strong>Localidad:</strong> {{ gestor.value.localidad_gestor }}</p>
      <p><strong>Barrio:</strong> {{ gestor.value.barrio_gestor }}</p>
      <p><strong>Dirección:</strong> {{ gestor.value.direccion_gestor }}</p>
      <p><strong>Fecha inicio:</strong> {{ gestor.value.fecha_inicio }}</p>
      <p><strong>Fecha final:</strong> {{ gestor.value.fecha_final }}</p>
      <p><strong>Actividad:</strong> {{ gestor.value.actividad_ejecutada }}</p>
      <p><strong>Capacidad (t/mes):</strong> {{ gestor.value.capacidad_t_mes }}</p>
      <p><strong>Capacidad total (t):</strong> {{ gestor.value.capacidad_total_t }}</p>
    </div>

    <div class="summary-block">
      <h4>Información Extra</h4>
      <p>
        <strong>Fecha de expedición del PIN:</strong>
        {{ infoextra.value.fecha_expedicion_pin }}
      </p>
      <p><strong>Consecutivo SIGOB:</strong> {{ infoextra.value.consecutivo_sigob }}</p>
      <p><strong>Clave:</strong> {{ infoextra.value.clave }}</p>
  <p><strong>Numero de Resolución:</strong> {{ infoextra.value.numeroResolucion }}</p>
      
      <p>
        <strong>Capacidad Total Autorizada :</strong> Toneladas :
        {{ infoextra.value.cantidad_autorizada }}
      </p>
    </div>

    <div class="summary-block">
      <h4>Documentos cargados</h4>
      <ul>
        <li *ngFor="let doc of uploadedDocs">{{ doc.name }}</li>
      </ul>
    </div>
  </div>

  <!-- BOTONES -->
  <div class="button-group">
    <button mat-button type="button" (click)="prevStep()" [disabled]="step === 0">Anterior</button>

    <button
      mat-raised-button
      color="primary"
      type="button"
      (click)="nextStep()"
      *ngIf="step < totalSteps - 1"
    >
      Siguiente
    </button>

    <button mat-raised-button color="accent" type="submit" *ngIf="step === totalSteps - 1" [disabled]="isSubmitting">
      Enviar
    </button>
  </div>
</form>
