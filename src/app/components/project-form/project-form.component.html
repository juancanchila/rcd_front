<div class="form-host">

  <!-- Barra de progreso -->
  <mat-progress-bar
    mode="determinate"
    [value]="(step + 1) * (100 / totalSteps)">
  </mat-progress-bar>

  <!-- PASO 0 ‚Äî DATOS DEL VEH√çCULO -->
  <div *ngIf="step === 0">


   
 <project-data  [group]="proyecto!"></project-data>
<map-picker (coordinates)="onMap($event)"></map-picker>
    <div class="form-actions">
      <button mat-flat-button color="primary" (click)="nextStep()">Siguiente</button>
    </div>
    
  </div>

 <!-- PASO 1: DOCUMENTOS -->
<div *ngIf="step === 1" [formGroup]="vehicleDocumentsForm" class="vehicle-documents">
<div *ngIf="proyecto.get('tipo_de_generador')?.value === 'PEQUE√ëO GENERADOR QUE NO REQUIERE LICENCIA O PERMISO.'">
  <h3 class="section-title">Documentos Del Proyecto</h3>
    <div class="file-group">
    <label>Carta de Solicitud(PDF) *</label>
    <input 
        type="file" 
        (change)="onFileSelected($event, 'carta_solicitud')" 
        accept=".pdf" 
    />
    
    <div class="error" *ngIf="isInvalid('carta_solicitud', vehicleDocumentsForm)">
        Debes adjuntar la Carta de Solicitud para continuar.
    </div>
</div>
<!---->
<div class="file-group">
  <label>
        Descripci√≥n t√©cnica del proyecto
        <span *ngIf="isRequired('descripcion_tecnica_proyecto')" class="asterisk">*</span>
    </label>
<input
        id="descripcion_tecnica_proyecto"
        type="file"
        (change)="onFileSelected($event, 'descripcion_tecnica_proyecto')"
        accept=".pdf"
    />
    <p class="help-text">Debe incluir planos, ubicaci√≥n, √°rea intervenida y objetivo del proyecto.</p>
    <div class="error" >
        Debes adjuntar la Descripci√≥n T√©cnica del Proyecto.
    </div>
</div>
<div class="file-group">
    <label [class.required]="isRequired('certificado_tradicion_libertad')">
        Certificado de Tradici√≥n y Libertad del inmueble
        <span *ngIf="isRequired('certificado_tradicion_libertad')" class="asterisk">*</span>
    </label>
    <input
        id="certificado_tradicion_libertad"
        type="file"
        (change)="onFileSelected($event, 'certificado_tradicion_libertad')"
        accept=".pdf"
    />
    <p class="help-text">Fecha de expedici√≥n no mayor a 3 meses.</p>
    <div class="error" >
        Debes adjuntar el Certificado de Tradici√≥n y Libertad.
    </div>
</div>
<div class="file-group">
    <label [class.required]="isRequired('autorizacion_bic')">
        Copia de la autorizaci√≥n de intervenci√≥n de Bienes de Inter√©s Cultural (BIC) <em>(si aplica)</em>
        <span *ngIf="isRequired('autorizacion_bic')" class="asterisk">*</span>
    </label>
    <input
        id="autorizacion_bic"
        type="file"
        (change)="onFileSelected($event, 'autorizacion_bic')"
        accept=".pdf"
    />
    <p class="help-text">Solo en caso de que el inmueble est√© catalogado como BIC.</p>
    <div class="error" >
        Debes adjuntar la autorizaci√≥n de intervenci√≥n de BIC si aplica.
    </div>
</div>
<div class="file-group" >
    
    <label >
        Registro de defunci√≥n del propietario del bien inmueble <em>(si aplica)</em>
        <span *ngIf="isRequired('registro_defuncion')" class="asterisk">*</span>
    </label>
    
    <input
        id="registro_defuncion"
        type="file"
        (change)="onFileSelected($event, 'registro_defuncion')" 
        accept=".pdf"
    />
    
    <p class="help-text">
        En caso de fallecimiento del propietario, se debe anexar este documento junto con los siguientes:
    </p>

    <ul class="help-text">
        <li>
            Radicaci√≥n ante juzgado o notar√≠a del proceso de sucesi√≥n, o documento privado notariado suscrito por los posibles herederos donde se manifieste que no hay herederos con mayor derecho y se comprometan a realizar los tr√°mites de sucesi√≥n.
        </li>
        <li>Copia del documento de identificaci√≥n del o los herederos.</li>
        <li>Copia del registro civil de nacimiento de los hijos o registro de matrimonio del c√≥nyuge (seg√∫n el caso).</li>
    </ul>

    <div class="error">
        Debes adjuntar el registro de defunci√≥n del propietario si aplica.
    </div>
</div>
</div>

<div *ngIf="proyecto.get('tipo_de_generador')?.value === 'PEQUE√ëO GENERADOR DE RCD' ||
  proyecto.get('tipo_de_generador')?.value === 'GRAN GENERADOR DE RCD'">
 <h3 class="section-title">Documentos Del Proyecto</h3>
    <div class="file-group">
    <label>Carta de Solicitud(PDF) *</label>
    <input 
        type="file" 
        (change)="onFileSelected($event, 'carta_solicitud')" 
        accept=".pdf" 
    />
    
    <div class="error" *ngIf="isInvalid('carta_solicitud', vehicleDocumentsForm)">
        Debes adjuntar la Carta de Solicitud para continuar.
    </div>
</div>
<!---->
<div class="file-group">
  <label>
        Descripci√≥n t√©cnica del proyecto
        <span *ngIf="isRequired('descripcion_tecnica_proyecto')" class="asterisk">*</span>
    </label>
<input
        id="descripcion_tecnica_proyecto"
        type="file"
        (change)="onFileSelected($event, 'descripcion_tecnica_proyecto')"
        accept=".pdf"
    />
    <p class="help-text">Debe incluir planos, ubicaci√≥n, √°rea intervenida y objetivo del proyecto.</p>
    <div class="error" >
        Debes adjuntar la Descripci√≥n T√©cnica del Proyecto.
    </div>
</div>
<div class="file-group">
    <label [class.required]="isRequired('certificado_tradicion_libertad')">
        Certificado de Tradici√≥n y Libertad del inmueble
        <span *ngIf="isRequired('certificado_tradicion_libertad')" class="asterisk">*</span>
    </label>
    <input
        id="certificado_tradicion_libertad"
        type="file"
        (change)="onFileSelected($event, 'certificado_tradicion_libertad')"
        accept=".pdf"
    />
    <p class="help-text">Fecha de expedici√≥n no mayor a 3 meses.</p>
    <div class="error" >
        Debes adjuntar el Certificado de Tradici√≥n y Libertad.
    </div>
</div>
<div class="file-group">
    <label [class.required]="isRequired('autorizacion_bic')">
        Copia de la autorizaci√≥n de intervenci√≥n de Bienes de Inter√©s Cultural (BIC) <em>(si aplica)</em>
        <span *ngIf="isRequired('autorizacion_bic')" class="asterisk">*</span>
    </label>
    <input
        id="autorizacion_bic"
        type="file"
        (change)="onFileSelected($event, 'autorizacion_bic')"
        accept=".pdf"
    />
    <p class="help-text">Solo en caso de que el inmueble est√© catalogado como BIC.</p>
    <div class="error" >
        Debes adjuntar la autorizaci√≥n de intervenci√≥n de BIC si aplica.
    </div>
</div>
<div class="file-group" >
    
    <label >
        Registro de defunci√≥n del propietario del bien inmueble <em>(si aplica)</em>
        <span *ngIf="isRequired('registro_defuncion')" class="asterisk">*</span>
    </label>
    
    <input
        id="registro_defuncion"
        type="file"
        (change)="onFileSelected($event, 'registro_defuncion')" 
        accept=".pdf"
    />
    
    <p class="help-text">
        En caso de fallecimiento del propietario, se debe anexar este documento junto con los siguientes:
    </p>

    <ul class="help-text">
        <li>
            Radicaci√≥n ante juzgado o notar√≠a del proceso de sucesi√≥n, o documento privado notariado suscrito por los posibles herederos donde se manifieste que no hay herederos con mayor derecho y se comprometan a realizar los tr√°mites de sucesi√≥n.
        </li>
        <li>Copia del documento de identificaci√≥n del o los herederos.</li>
        <li>Copia del registro civil de nacimiento de los hijos o registro de matrimonio del c√≥nyuge (seg√∫n el caso).</li>
    </ul>

    <div class="error">
        Debes adjuntar el registro de defunci√≥n del propietario si aplica.
    </div>
</div>

<h3 class="section-title">Documentos Para Peque√±os y Grandes Generadores</h3>
<br>
<div class="file-group">
    <label >
        Cuadro de cantidades de RCD a generar, discriminados por tipo de RCD
        <span *ngIf="isRequired('cuadro_cantidades_rcd')" class="asterisk">*</span>
    </label>
    <input 
        id="cuadro_cantidades_rcd" 
        type="file" 
        (change)="onFileSelected($event, 'cuadro_cantidades_rcd')"
        accept=".pdf" 
    />
    <p class="help-text">
        Debe seguir la clasificaci√≥n establecida en el Art√≠culo 2 de la Resoluci√≥n 0472 de 2017.
    </p>
    <div class="error" >
        Debes adjuntar el Cuadro de Cantidades de RCD.
    </div>
</div>



<div class="file-group">
    <label >
        Soporte de pago del PIN
        <span *ngIf="isRequired('soporte_pago_pin')" class="asterisk">*</span>
    </label>
    <input 
        id="soporte_pago_pin" 
        type="file" 
        (change)="onFileSelected($event, 'soporte_pago_pin')"
        accept=".pdf" 
    />
    <p class="help-text">Comprobante de pago asociado al tr√°mite ambiental.</p>
    <div class="error" >
        Debes adjuntar el soporte de pago del PIN.
    </div>
</div>
<div class="file-group">
    <label class="required">
        Cronograma de actividades del proyecto
        <span class="asterisk">*</span>
    </label>
    <input 
        id="cronograma_actividades" 
        type="file" 
        (change)="onFileSelected($event, 'cronograma_actividades')" 
        accept=".pdf" 
    />
    <p class="help-text">Debe incluir las fechas estimadas y responsables de cada actividad.</p>
    
    <div class="error" *ngIf="false"> 
        Debes adjuntar el Cronograma de Actividades.
    </div>
</div>
<div class="file-group">
    <label class="required">
        Copia de los planos arquitect√≥nicos aprobados por curadur√≠a urbana
        <span class="asterisk">*</span>
    </label>
    <input 
        id="planos_aprobados_curaduria" 
        type="file" 
        (change)="onFileSelected($event, 'planos_aprobados_curaduria')" 
        accept=".pdf" 
    />
    <p class="help-text">Planos oficiales debidamente aprobados por la curadur√≠a urbana.</p>
    
    <div class="error" *ngIf="false"> 
        Debes adjuntar los planos aprobados por curadur√≠a.
    </div>
</div>
<div class="file-group">
    <label class="required">
        Contrato de Obra y OTROS√ç, debidamente firmados por las partes
        <span class="asterisk">*</span>
    </label>
    <input 
        id="contrato_obra_otros" 
        type="file" 
        (change)="onFileSelected($event, 'contrato_obra_otros')" 
        accept=".pdf" 
    />
    <p class="help-text">
        Aplica si la solicitud del PIN la realiza el contratista de obra.
    </p>
    <div class="error" *ngIf="false"> 
        Debes adjuntar el Contrato de Obra y sus otros√≠.
    </div>
</div>
<div class="file-group">
    <label class="required">
        Copia de la resoluci√≥n o licencia correspondiente
        <span class="asterisk">*</span>
    </label>
    <input 
        id="resolucion_curaduria_o_licencia" 
        type="file" 
        (change)="onFileSelected($event, 'resolucion_curaduria_o_licencia')" 
        accept=".pdf" 
    />
    <p class="help-text">
        Puede ser licencia urban√≠stica, de intervenci√≥n u ocupaci√≥n del espacio p√∫blico, o licencia ambiental (seg√∫n aplique).
    </p>
    <div class="error" *ngIf="false"> 
        Debes adjuntar la licencia o resoluci√≥n correspondiente.
    </div>
</div>
<div class="file-group">
    <label class="required">
        Programa de manejo ambiental de Residuos de Construcci√≥n y Demolici√≥n (RCD)
        <span class="asterisk">*</span>
    </label>
    <input 
        id="programa_manejo_rcd_pdf" 
        type="file" 
        (change)="onFileSelected($event, 'programa_manejo_rcd_pdf')"
        accept=".pdf" 
    />
    <p class="help-text">
        Formulado seg√∫n los requisitos m√≠nimos de la Resoluci√≥n 1257 de 2021 y los establecidos por la autoridad ambiental.
    </p>
    <div class="error" *ngIf="false"> 
        Debes adjuntar el Programa de Manejo Ambiental de RCD.
    </div>
</div>
<div class="file-group">
    <label>
        Copia de la autorizaci√≥n de intervenci√≥n de Bienes de Inter√©s Cultural (BIC)
        <em>(si aplica)</em>
    </label>
    <input 
        id="autorizacion_bicBigOrSmall" 
        type="file" 
        (change)="onFileSelected($event, 'autorizacion_bicBigOrSmall')" 
        accept=".pdf" 
    />
    <p class="help-text">
        Expedido por la Alcald√≠a Mayor de Cartagena (art√≠culos 9 al 12 del Decreto 0404 de 2024).
    </p>
    <div class="error" *ngIf="false"> 
        Debes adjuntar la autorizaci√≥n BIC.
    </div>
</div>
<div class="file-group">
    <label>
        Certificado de Planeaci√≥n (si no se requiere licencia)
    </label>
    <input 
        id="certificado_no_requiere_licencia" 
        type="file" 
        (change)="onFileSelected($event, 'certificado_no_requiere_licencia')"
        accept=".pdf" 
    />
    <p class="help-text">
        Certificado expedido por la Secretar√≠a de Planeaci√≥n donde conste que no se requiere licencia de intervenci√≥n y ocupaci√≥n de espacio p√∫blico.
    </p>
    <div class="error" *ngIf="false"> 
        Debes adjuntar el Certificado de Planeaci√≥n.
    </div>
</div>
<div class="file-group">
    <label>
        Permiso de ocupaci√≥n de cauce <em>(si aplica)</em>
    </label>
    <input 
        id="permiso_ocupacion_cauce" 
        type="file" 
        (change)="onFileSelected($event, 'permiso_ocupacion_cauce')"
        accept=".pdf" 
    />
    <p class="help-text">
        Copia del acto administrativo a trav√©s del cual se otorga el permiso de ocupaci√≥n de cauce.
    </p>
    <div class="error" *ngIf="false">
        Debes adjuntar el Permiso de ocupaci√≥n de cauce.
    </div>
</div>

  <!-- üìù Nota general -->
  <p class="help-text final-note">
    Todos los documentos deben presentarse en formato PDF, con nombre del proyecto y fecha de emisi√≥n visibles.
  </p>
</div>
  



  <!-- Mensaje general de validaci√≥n -->
  <div class="form-errors" *ngIf="vehicleDocumentsForm.invalid && vehicleDocumentsForm.touched">
    <p class="error">Revisa los campos marcados en rojo y adjunta los documentos obligatorios.</p>
  </div>

  <!-- Botones -->
  <div class="form-actions">
    <button mat-stroked-button type="button" (click)="prevStep()">Anterior</button>
    <button mat-flat-button color="primary" type="button" (click)="nextStep()">Siguiente</button>
  </div>
</div>


  <!-- PASO 2 ‚Äî INFORMACI√ìN ADICIONAL -->
  <div *ngIf="step === 2" [formGroup]="infoextra">
    
    <h3>Informaci√≥n adicional</h3>

    <mat-form-field appearance="outline">
      <mat-label>Fecha de expedici√≥n del PIN</mat-label>
      <input matInput type="date" formControlName="fecha_expedicion_pin" />
      <mat-error *ngIf="isInvalid('fecha_expedicion_pin', infoextra)">
        Debes ingresar la fecha de expedici√≥n del PIN.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Consecutivo SIGOB</mat-label>
      <input matInput formControlName="consecutivo_sigob" placeholder="Ej: 2025-000123" />
      <mat-error *ngIf="isInvalid('consecutivo_sigob', infoextra)">
        Debes ingresar el consecutivo SIGOB.
      </mat-error>
    </mat-form-field>

    <div class="form-actions">
      <button mat-stroked-button (click)="prevStep()">Anterior</button>
      <button mat-flat-button color="primary" (click)="nextStep()">Siguiente</button>
    </div>
  </div>

  <!-- PASO 3 ‚Äî RESUMEN FINAL -->
  <div *ngIf="step === 3 " >
<div *ngIf="proyecto.get('tipo_de_generador')?.value === 'PEQUE√ëO GENERADOR QUE NO REQUIERE LICENCIA O PERMISO.' ">
    <h2>Resumen del Proyecto</h2>

    <div class="summary-box" >

      <p><strong>Tipo de Generador:</strong> {{ proyecto.get('tipo_de_generador')?.value }}</p>
      <p><strong>Localidad:</strong> {{ proyecto.get('localidad_proyecto')?.value }}</p>
    <p><strong>Barrio:</strong> {{ proyecto.get('barrio_proyecto')?.value }}</p>

<p><strong>Direcci√≥n del Proyecto:</strong> {{ proyecto.get('direccion_del_proyecto')?.value }}</p>

<p><strong>Fecha Inicio:</strong> {{ proyecto.get('fecha_inicio')?.value | date:'dd/MM/yyyy' }}</p>

<p><strong>Fecha Final:</strong> {{ proyecto.get('fecha_final')?.value | date:'dd/MM/yyyy' }}</p>

<p><strong>Nombre del Proyecto:</strong> {{ proyecto.get('nombre_del_proyecto')?.value }}</p>

    <div *ngFor="let predio of proyecto.get('datos_predios')?.value; let i = index">
  <p><strong>Predio {{ i + 1 }}</strong></p>

  <p><strong>Referencia Catastral:</strong> {{ predio.referencia_catastral }}</p>
  <p><strong>Matr√≠cula Inmobiliaria:</strong> {{ predio.matricula_inmobiliaria }}</p>
<p>
  <strong>Descripci√≥n del proyecto o actividad:</strong><br />
  {{ proyecto.get('descripcion_del_proyecto_o_actividad_a_ejecutar')?.value }}
</p>
<p>
  <strong>√Årea a Intervenir (m¬≤):</strong>
  {{ proyecto.get('area_a_intervenir_m2')?.value }}
</p>

<p>
  <strong>Cantidad de RCD a generar (Toneladas):</strong>
  {{ proyecto.get('cantidad_de_rcd_a_generar_toneladas')?.value }}
</p>
<p>


      <h3>Documentos cargados</h3>
      <ul>
        <li *ngFor="let doc of getUploadedDocuments()">{{ doc }}</li>
      </ul>

      <h3>Informaci√≥n adicional</h3>
      <p><strong>Fecha PIN:</strong> {{ infoextra.get('fecha_expedicion_pin')?.value }}</p>
      <p><strong>Consecutivo SIGOB:</strong> {{ infoextra.get('consecutivo_sigob')?.value }}</p>

    </div>
    </div>
     <div class="form-actions">
      <button mat-stroked-button (click)="prevStep()">Anterior</button>
      <button mat-flat-button color="accent" (click)="onSubmit()">Guardar</button>
    </div>
</div>
<!-- este resumen es para peque√±os o grandes-->

<div *ngIf="proyecto.get('tipo_de_generador')?.value === 'PEQUE√ëO GENERADOR DE RCD' ||
  proyecto.get('tipo_de_generador')?.value === 'GRAN GENERADOR DE RCD'">
    <h2>Resumen del Proyecto</h2>

    <div class="summary-box">

      <p><strong>Tipo de Generador:</strong> {{ proyecto.get('tipo_de_generador')?.value }}</p>
      <p><strong>Localidad:</strong> {{ proyecto.get('localidad_proyecto')?.value }}</p>
    <p><strong>Barrio:</strong> {{ proyecto.get('barrio_proyecto')?.value }}</p>

<p><strong>Direcci√≥n del Proyecto:</strong> {{ proyecto.get('direccion_del_proyecto')?.value }}</p>

<p><strong>Fecha Inicio:</strong> {{ proyecto.get('fecha_inicio')?.value | date:'dd/MM/yyyy' }}</p>

<p><strong>Fecha Final:</strong> {{ proyecto.get('fecha_final')?.value | date:'dd/MM/yyyy' }}</p>

<p><strong>Nombre del Proyecto:</strong> {{ proyecto.get('nombre_del_proyecto')?.value }}</p>

    <div *ngFor="let predio of proyecto.get('datos_predios')?.value; let i = index">
  <p><strong>Predio {{ i + 1 }}</strong></p>

  <p><strong>Referencia Catastral:</strong> {{ predio.referencia_catastral }}</p>
  <p><strong>Matr√≠cula Inmobiliaria:</strong> {{ predio.matricula_inmobiliaria }}</p>
<p>
  <strong>Descripci√≥n del proyecto o actividad:</strong><br />
  {{ proyecto.get('descripcion_del_proyecto_o_actividad_a_ejecutar')?.value }}
</p>
<p>
  <strong>√Årea a Intervenir (m¬≤):</strong>
  {{ proyecto.get('area_a_intervenir_m2')?.value }}
</p>

<p>
  <strong>Cantidad de RCD a generar (Toneladas):</strong>
  {{ proyecto.get('cantidad_de_rcd_a_generar_toneladas')?.value }}
</p>
<h2>Tipo de Licencia</h2>

<div class="summary-section">
  <h3>1. Urbanizaci√≥n</h3>
  <ul *ngIf="getLicenciaOptions('urbanizacion_block_0100').length > 0; else noUrbanizacion">
    <li *ngFor="let opcion of getLicenciaOptions('urbanizacion_block_0100')">
      {{ opcion }}
    </li>
  </ul>
  <ng-template #noUrbanizacion><p>‚Äî No aplica.</p></ng-template>
</div>

<hr>

<div class="summary-section">
  <h3>2. Construcci√≥n</h3>
  <ul *ngIf="getLicenciaOptions('construccion_block_0100').length > 0; else noConstruccion">
    <li *ngFor="let opcion of getLicenciaOptions('construccion_block_0100')">
      {{ opcion }}
    </li>
  </ul>
  <ng-template #noConstruccion><p>‚Äî No aplica.</p></ng-template>
</div>

<hr>

<div class="summary-section">
  <h3>3. Permiso de Intervenci√≥n BIC</h3>
  <ul *ngIf="getLicenciaOptions('bic_block_0100').length > 0; else noBic">
    <li *ngFor="let opcion of getLicenciaOptions('bic_block_0100')">
      {{ opcion }}
    </li>
  </ul>
  <ng-template #noBic><p>‚Äî No aplica.</p></ng-template>
</div>

<hr>

<div class="summary-section">
  <h3>4. Intervenci√≥n / Ocupaci√≥n del Espacio P√∫blico</h3>
  <ul *ngIf="getLicenciaOptions('espacio_publico_block_0100').length > 0; else noEspacio">
    <li *ngFor="let opcion of getLicenciaOptions('espacio_publico_block_0100')">
      {{ opcion }}
    </li>
  </ul>
  <ng-template #noEspacio><p>‚Äî No aplica.</p></ng-template>
</div>

<hr>

<div class="summary-section">
  <h3>5. Demolici√≥n por Declaraci√≥n de Estado de Ruina</h3>
  <p>Respuesta: <strong>{{ getDemolicionRespuesta() || 'NO' }}</strong></p>
</div>

<hr>

<div class="summary-section">
  <h3>No. Resoluci√≥n Licencia / Autorizaci√≥n BIC</h3>
  <p>N√∫mero: <strong>{{ getResolucionNumero() || 'N/A' }}</strong></p>
</div>
<p>


      <h3>Documentos cargados</h3>
      <ul>
        <li *ngFor="let doc of getUploadedDocuments()">{{ doc }}</li>
      </ul>

      <h3>Informaci√≥n adicional</h3>
      <p><strong>Fecha PIN:</strong> {{ infoextra.get('fecha_expedicion_pin')?.value }}</p>
      <p><strong>Consecutivo SIGOB:</strong> {{ infoextra.get('consecutivo_sigob')?.value }}</p>

    </div>

</div>
 

   <div class="form-actions">
      <button mat-stroked-button (click)="prevStep()">Anterior</button>
      <button mat-flat-button color="accent" (click)="onSubmit()">Guardar</button>
    </div>
</div>
