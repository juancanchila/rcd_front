<form [formGroup]="form" (ngSubmit)="onSubmit()" class="form-host">
  <mat-progress-bar mode="determinate" [value]="(step + 1) * (100 / totalSteps)"></mat-progress-bar>

  <!-- PASO 0: DATOS DE CONTACTO -->
  <div *ngIf="step === 0" [formGroup]="contacto">
    <h3>Datos de Contacto</h3>
    <p>Ingresar la información del propietario del vehículo.</p>

    <mat-form-field appearance="outline">
      <mat-label>Tipo de solicitante</mat-label>
      <mat-select formControlName="tipo_de_solicitante" required>
        <mat-option value="Persona Natural">Persona Natural</mat-option>
        <mat-option value="Persona Jurídica">Persona Jurídica</mat-option>
      </mat-select>
      <mat-error *ngIf="isInvalid('tipo_de_solicitante', contacto)">
        Debes seleccionar el tipo de solicitante.
      </mat-error>
    </mat-form-field>

    <!-- Persona Natural -->
    <ng-container *ngIf="contacto.get('tipo_de_solicitante')?.value === 'Persona Natural'">
      <mat-form-field appearance="outline">
        <mat-label>Nombres y apellidos</mat-label>
        <input matInput formControlName="nombres_y_apellidos" placeholder="Ej: Juan Pérez" />
        <mat-error *ngIf="isInvalid('nombres_y_apellidos', contacto)">
          Debes ingresar nombres y apellidos.
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Documento de identidad</mat-label>
        <input matInput formControlName="documento_de_identidad" placeholder="Ej: 1234567890" />
        <mat-error *ngIf="isInvalid('documento_de_identidad', contacto)">
          Debes ingresar el documento de identidad.
        </mat-error>
      </mat-form-field>
    </ng-container>

    <!-- Persona Jurídica -->
    <ng-container *ngIf="contacto.get('tipo_de_solicitante')?.value === 'Persona Jurídica'">
      <mat-form-field appearance="outline">
        <mat-label>Razón social</mat-label>
        <input matInput formControlName="razon_social" placeholder="Ej: Comercializadora ABC S.A.S" />
        <mat-error *ngIf="isInvalid('razon_social', contacto)">
          Debes ingresar la razón social.
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>NIT</mat-label>
        <input matInput formControlName="nit" placeholder="Ej: 900123456-7" />
        <mat-error *ngIf="isInvalid('nit', contacto)">
          Debes ingresar el NIT.
        </mat-error>
      </mat-form-field>
    </ng-container>

    <mat-form-field appearance="outline">
      <mat-label>Correo electrónico</mat-label>
      <input matInput type="email" formControlName="correo_electronico" placeholder="ejemplo@correo.com" />
      <mat-error *ngIf="isInvalid('correo_electronico', contacto)">
        Ingresa un correo válido.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Teléfono móvil</mat-label>
      <input matInput formControlName="telefono_movil" placeholder="Ej: 3001234567" />
      <mat-error *ngIf="isInvalid('telefono_movil', contacto)">
        Debes ingresar el teléfono móvil.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Teléfono fijo</mat-label>
      <input matInput formControlName="telefono_fijo" placeholder="Ej: 6051234567" />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Localidad</mat-label>
      <mat-select formControlName="localidad" required>
        <mat-option value="localidad1">Localidad 1</mat-option>
        <mat-option value="localidad2">Localidad 2</mat-option>
        <mat-option value="localidad3">Localidad 3</mat-option>
      </mat-select>
      <mat-error *ngIf="isInvalid('localidad', contacto)">
        Debes seleccionar la localidad.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Barrio</mat-label>
      <input matInput formControlName="barrio" [matAutocomplete]="autoBarrio" placeholder="Empieza a escribir" />
      <mat-autocomplete #autoBarrio="matAutocomplete">
        <mat-option *ngFor="let barrio of barriosFiltrados$ | async" [value]="barrio">{{ barrio }}</mat-option>
      </mat-autocomplete>
      <mat-error *ngIf="isInvalid('barrio', contacto)">
        Debes seleccionar un barrio.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Dirección de correspondencia</mat-label>
      <input matInput formControlName="direccion_de_correspondencia_del_solicitante" placeholder="Ej: Calle 45 #12-34" />
      <mat-error *ngIf="isInvalid('direccion_de_correspondencia_del_solicitante', contacto)">
        Debes ingresar la dirección de correspondencia.
      </mat-error>
    </mat-form-field>
  </div>

  <!-- PASO 1: VEHÍCULO -->
  <div *ngIf="step === 1" [formGroup]="vehiculo">
    <h3>Datos del vehículo</h3>
    <label>Unidad de capacidad</label>
    <mat-radio-group formControlName="unidad_capacidad">
      <mat-radio-button value="kg">Kg</mat-radio-button>
      <mat-radio-button value="ton">Ton</mat-radio-button>
    </mat-radio-group>
    <mat-error *ngIf="isInvalid('unidad_capacidad', vehiculo)">
      Selecciona la unidad de capacidad.
    </mat-error>

    <mat-form-field appearance="outline">
      <mat-label>Capacidad del vehículo</mat-label>
      <input matInput type="number" formControlName="capacidad_vehiculo" />
      <mat-error *ngIf="isInvalid('capacidad_vehiculo', vehiculo)">
        Ingresa la capacidad del vehículo (mínimo 1).
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Clase del vehículo</mat-label>
      <input matInput formControlName="clase_vehiculo" />
      <mat-error *ngIf="isInvalid('clase_vehiculo', vehiculo)">Debes ingresar la clase del vehículo.</mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Placa del vehículo</mat-label>
      <input matInput formControlName="placa_vehiculo" maxlength="6" placeholder="Formato: ABC123 o AB1234" />
      <mat-error *ngIf="isInvalid('placa_vehiculo', vehiculo)">
        Debes ingresar una placa válida.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Marca</mat-label>
      <input matInput formControlName="marca" />
      <mat-error *ngIf="isInvalid('marca', vehiculo)">Debes ingresar la marca.</mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Modelo</mat-label>
      <input matInput formControlName="modelo" />
      <mat-error *ngIf="isInvalid('modelo', vehiculo)">Debes ingresar el modelo.</mat-error>
    </mat-form-field>
  </div>

 <!-- PASO 2: DOCUMENTOS -->
<div *ngIf="step === 2" class="vehicle-documents">
  <h3 class="section-title">Documentos del vehículo</h3>

  <!-- Dependiendo del tipo de solicitante -->
  <ng-container *ngIf="contacto.get('tipo_de_solicitante')?.value as tipo">
    <!-- Persona Natural -->
    <div *ngIf="tipo === 'Persona Natural'" class="file-group">
      <label [class.required]="isInvalid('identificacion', vehiculodocuments)">
        Identificación (PDF) <span *ngIf="isRequired('identificacion')" class="asterisk">*</span>
      </label>
      <input type="file" (change)="onFileSelected($event, 'identificacion')" accept=".pdf" />
      <mat-error *ngIf="isInvalid('identificacion', vehiculodocuments)">
        Debes adjuntar la identificación.
      </mat-error>
    </div>

    <!-- Persona Jurídica -->
    <div *ngIf="tipo === 'Persona Jurídica'" class="file-group">
      <label [class.required]="isInvalid('cert_ext_legal', vehiculodocuments)">
        Certificado de existencia y representación legal (PDF)
        <span *ngIf="isRequired('cert_ext_legal')" class="asterisk">*</span>
      </label>
      <input type="file" (change)="onFileSelected($event, 'cert_ext_legal')" accept=".pdf" />
      <mat-error *ngIf="isInvalid('cert_ext_legal', vehiculodocuments)">
        Debes adjuntar el certificado.
      </mat-error>
    </div>
  </ng-container>

  <!-- Documentos comunes -->
  <div class="file-group">
    <label [class.required]="isInvalid('licencia_transito', vehiculodocuments)">
      Licencia de tránsito (tarjeta de propiedad)
      <span *ngIf="isRequired('licencia_transito')" class="asterisk">*</span>
    </label>
    <input type="file" (change)="onFileSelected($event, 'licencia_transito')" accept=".pdf" />
    <mat-error *ngIf="isInvalid('licencia_transito', vehiculodocuments)">
      Debes adjuntar la licencia.
    </mat-error>
  </div>

  <div class="file-group">
    <label [class.required]="isInvalid('foto_frontal', vehiculodocuments)">
      Foto frontal (JPG/PNG) <span *ngIf="isRequired('foto_frontal')" class="asterisk">*</span>
    </label>
    <input type="file" (change)="onFileSelected($event, 'foto_frontal')" accept=".jpg,.jpeg,.png" />
    <mat-error *ngIf="isInvalid('foto_frontal', vehiculodocuments)">
      Debes adjuntar la foto frontal.
    </mat-error>
  </div>

  <div class="file-group">
    <label [class.required]="isInvalid('foto_trasera', vehiculodocuments)">
      Foto trasera (JPG/PNG) <span *ngIf="isRequired('foto_trasera')" class="asterisk">*</span>
    </label>
    <input type="file" (change)="onFileSelected($event, 'foto_trasera')" accept=".jpg,.jpeg,.png" />
    <mat-error *ngIf="isInvalid('foto_trasera', vehiculodocuments)">
      Debes adjuntar la foto trasera.
    </mat-error>
  </div>

  <div class="file-group">
    <label [class.required]="isInvalid('foto_lateral_derecha', vehiculodocuments)">
      Foto lateral derecha (JPG/PNG) <span *ngIf="isRequired('foto_lateral_derecha')" class="asterisk">*</span>
    </label>
    <input type="file" (change)="onFileSelected($event, 'foto_lateral_derecha')" accept=".jpg,.jpeg,.png" />
    <mat-error *ngIf="isInvalid('foto_lateral_derecha', vehiculodocuments)">
      Debes adjuntar la foto lateral derecha.
    </mat-error>
  </div>

  <div class="file-group">
    <label [class.required]="isInvalid('foto_lateral_izquierda', vehiculodocuments)">
      Foto lateral izquierda (JPG/PNG) <span *ngIf="isRequired('foto_lateral_izquierda')" class="asterisk">*</span>
    </label>
    <input type="file" (change)="onFileSelected($event, 'foto_lateral_izquierda')" accept=".jpg,.jpeg,.png" />
    <mat-error *ngIf="isInvalid('foto_lateral_izquierda', vehiculodocuments)">
      Debes adjuntar la foto lateral izquierda.
    </mat-error>
  </div>

  <div class="file-group">
    <label [class.required]="isInvalid('registro_herramientas', vehiculodocuments)">
      Registro fotográfico de herramientas o kit de limpieza (PDF/JPG/PNG)
      <span *ngIf="isRequired('registro_herramientas')" class="asterisk">*</span>
    </label>
    <input type="file" (change)="onFileSelected($event, 'registro_herramientas')" accept=".pdf,.jpg,.jpeg,.png" />
    <mat-error *ngIf="isInvalid('registro_herramientas', vehiculodocuments)">
      Debes adjuntar el registro.
    </mat-error>
  </div>

  <div class="file-group">
    <label [class.required]="isInvalid('certificado_tecnicomecanica', vehiculodocuments)">
      Certificado técnico-mecánica (PDF) <span *ngIf="isRequired('certificado_tecnicomecanica')" class="asterisk">*</span>
    </label>
    <input type="file" (change)="onFileSelected($event, 'certificado_tecnicomecanica')" accept=".pdf" />
    <mat-error *ngIf="isInvalid('certificado_tecnicomecanica', vehiculodocuments)">
      Debes adjuntar el certificado técnico-mecánica.
    </mat-error>
  </div>

  <div class="file-group">
    <label [class.required]="isInvalid('certificado_leasing', vehiculodocuments)">
      Certificado entidad financiera Leasing (PDF)
      <span *ngIf="isRequired('certificado_leasing')" class="asterisk">*</span>
    </label>
    <input type="file" (change)="onFileSelected($event, 'certificado_leasing')" accept=".pdf" />
    <small *ngIf="vehiculo.get('modalidad_vehiculo')?.value === 'Leasing'">
      Adjuntar certificado expedido por entidad bancaria o financiera, no mayor a 3 meses.
    </small>
    <mat-error *ngIf="isInvalid('certificado_leasing', vehiculodocuments)">
      Debes adjuntar el certificado.
    </mat-error>
  </div>

  <!-- Opcionales -->
  <div class="file-group">
    <label>Registro de defunción del propietario (opcional)</label>
    <input type="file" (change)="onFileSelected($event, 'registro_defuncion')" accept=".pdf" />
  </div>

  <div class="file-group">
    <label>Autorización del propietario (opcional)</label>
    <input type="file" (change)="onFileSelected($event, 'autoriza_propietario')" accept=".pdf" />
  </div>

  <!-- Mensaje general de validación -->
  <div class="form-errors" *ngIf="vehiculodocuments.invalid && vehiculodocuments.touched">
    <p class="error">Revisa los campos marcados en rojo y adjunta los documentos obligatorios.</p>
  </div>
</div>

<!-- PASO 3: INFORMACIÓN ADICIONAL -->
<div *ngIf="step === 3" [formGroup]="infoextra">
  <h3>Información adicional</h3>

  <mat-form-field appearance="outline">
    <mat-label>Fecha de expedición del PIN</mat-label>
    <input matInput type="date" formControlName="fecha_expedicion_pin" />
    <mat-error *ngIf="isInvalid('fecha_expedicion_pin', infoextra)">
      Debes ingresar la fecha de expedición del PIN.
    </mat-error>
  </mat-form-field>

  <mat-form-field appearance="outline">
    <mat-label>Consecutivo SIGOB</mat-label>
    <input matInput formControlName="consecutivo_sigob" placeholder="Ej: 2025-000123" />
    <mat-error *ngIf="isInvalid('consecutivo_sigob', infoextra)">
      Debes ingresar el consecutivo SIGOB.
    </mat-error>
  </mat-form-field>
</div>

 <!-- PASO 4: RESUMEN -->
  <div *ngIf="step === 4" class="summary-container">
    <h3>Resumen del Transportador</h3>
    <p>Verifica los datos antes de guardar.</p>

    <div class="summary-section">
      <h4>Datos de Contacto</h4>
      <table>
        <tr><td><strong>Nombres:</strong></td><td>{{ contacto.get('nombres_y_apellidos')?.value }}</td></tr>
        <tr><td><strong>Correo:</strong></td><td>{{ contacto.get('correo_electronico')?.value }}</td></tr>
        <tr><td><strong>Teléfono:</strong></td><td>{{ contacto.get('telefono_movil')?.value }}</td></tr>
      </table>
    </div>

    <div class="summary-section">
      <h4>Datos del Vehículo</h4>
      <table>
        <tr><td><strong>Clase:</strong></td><td>{{ vehiculo.get('clase_vehiculo')?.value }}</td></tr>
        <tr><td><strong>Placa:</strong></td><td>{{ vehiculo.get('placa_vehiculo')?.value }}</td></tr>
        <tr><td><strong>Marca:</strong></td><td>{{ vehiculo.get('marca')?.value }}</td></tr>
        <tr><td><strong>Modelo:</strong></td><td>{{ vehiculo.get('modelo')?.value }}</td></tr>
        <tr><td><strong>Capacidad:</strong></td>
          <td>{{ vehiculo.get('capacidad_vehiculo')?.value }} {{ vehiculo.get('unidad_capacidad')?.value }}</td>
        </tr>
      </table>
    </div>

    <div class="summary-section">
      <h4>Documentos Cargados</h4>
      <ul>
        <li *ngFor="let doc of getUploadedDocuments()">{{ doc }}</li>
      </ul>
    </div>
  </div>


  <!-- BOTONES -->
  <div class="form-actions">
    <button mat-stroked-button type="button" (click)="prevStep()" [disabled]="step === 0">Anterior</button>
    <button mat-stroked-button type="button" (click)="nextStep()" *ngIf="step < totalSteps - 1">Siguiente</button>
    <button mat-flat-button color="primary" type="submit" *ngIf="step === totalSteps - 1">Guardar</button>
  </div>
</form>
